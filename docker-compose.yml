# ==============================================================================
# FESTIVALS - DOCKER COMPOSE CONFIGURATION
# ==============================================================================
# Main docker-compose configuration for the Festivals project.
#
# Usage:
#   Development:  docker compose up
#   Production:   docker compose -f docker-compose.yml -f docker-compose.prod.yml up
#
# Environment Variables:
#   Copy .env.example to .env and configure your settings:
#   cp .env.example .env
#
# For local development customization, copy docker-compose.override.yml.example:
#   cp docker-compose.override.yml.example docker-compose.override.yml
# ==============================================================================

services:
  # ============================================================================
  # BACKEND API
  # ============================================================================
  # Go backend API with hot reload for development
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    ports:
      - "${API_PORT:-8080}:8080"
    environment:
      # Server Configuration
      - PORT=${PORT:-8080}
      - ENVIRONMENT=${ENVIRONMENT:-development}
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - DEBUG=${DEBUG:-false}

      # Database (uses internal docker network hostname)
      - DATABASE_URL=postgres://${POSTGRES_USER:-festivals}:${POSTGRES_PASSWORD:-password}@postgres:5432/${POSTGRES_DB:-festivals}?sslmode=disable

      # Redis (uses internal docker network hostname)
      - REDIS_URL=redis://${REDIS_PASSWORD:+:${REDIS_PASSWORD}@}redis:6379/${REDIS_DB:-0}

      # Auth0
      - AUTH0_DOMAIN=${AUTH0_DOMAIN:-}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-}

      # JWT/Security
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-key-change-in-production}

      # Stripe
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY:-}
      - STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET:-}

      # Storage (uses internal docker network hostname)
      - MINIO_ENDPOINT=minio:9000
      - MINIO_ACCESS_KEY=${MINIO_ACCESS_KEY:-minio}
      - MINIO_SECRET_KEY=${MINIO_SECRET_KEY:-minio123}
      - MINIO_BUCKET=${MINIO_BUCKET:-festivals}
      - MINIO_USE_SSL=${MINIO_USE_SSL:-false}

      # Email
      - EMAIL_PROVIDER=${EMAIL_PROVIDER:-postal}
      - POSTAL_URL=${POSTAL_URL:-http://localhost:5000}
      - POSTAL_API_KEY=${POSTAL_API_KEY:-}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY:-}

      # SMS (Twilio)
      - TWILIO_ACCOUNT_SID=${TWILIO_ACCOUNT_SID:-}
      - TWILIO_AUTH_TOKEN=${TWILIO_AUTH_TOKEN:-}
      - TWILIO_FROM_NUMBER=${TWILIO_FROM_NUMBER:-}
      - TWILIO_RATE_LIMIT=${TWILIO_RATE_LIMIT:-10}

      # OpenAI
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - OPENAI_EMBED_MODEL=${OPENAI_EMBED_MODEL:-text-embedding-3-small}

      # Feature Flags
      - FEATURE_NFC_PAYMENTS=${FEATURE_NFC_PAYMENTS:-true}
      - FEATURE_WALLET_TOPUP=${FEATURE_WALLET_TOPUP:-true}
      - FEATURE_AI_CHATBOT=${FEATURE_AI_CHATBOT:-true}

      # Monitoring
      - SENTRY_DSN=${SENTRY_DSN:-}
      - SENTRY_ENVIRONMENT=${SENTRY_ENVIRONMENT:-development}
      - METRICS_ENABLED=${METRICS_ENABLED:-true}

    volumes:
      - ./backend:/app
      - go_modules:/go/pkg/mod
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    restart: unless-stopped
    networks:
      - festivals-network

  # ============================================================================
  # ADMIN DASHBOARD
  # ============================================================================
  # Next.js admin dashboard
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile.dev
    ports:
      - "${ADMIN_PORT:-3000}:3000"
    environment:
      # Environment
      - NODE_ENV=${NODE_ENV:-development}

      # API URLs
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080}
      - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:8080/ws}
      - API_URL=http://api:8080

      # Auth0
      - AUTH0_SECRET=${AUTH0_SECRET:-}
      - AUTH0_BASE_URL=${AUTH0_BASE_URL:-http://localhost:3000}
      - AUTH0_ISSUER_BASE_URL=https://${AUTH0_DOMAIN:-}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID:-}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET:-}
      - AUTH0_AUDIENCE=${AUTH0_AUDIENCE:-}

      # Stripe
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${STRIPE_PUBLISHABLE_KEY:-}

      # Feature Flags
      - NEXT_PUBLIC_FEATURE_NFC_PAYMENTS=${FEATURE_NFC_PAYMENTS:-true}
      - NEXT_PUBLIC_FEATURE_AI_CHATBOT=${FEATURE_AI_CHATBOT:-true}

      # Monitoring
      - NEXT_PUBLIC_SENTRY_DSN=${SENTRY_DSN:-}

    depends_on:
      - api
    restart: unless-stopped
    networks:
      - festivals-network

  # ============================================================================
  # NGINX REVERSE PROXY
  # ============================================================================
  # Optional nginx proxy for SSL termination and routing
  nginx:
    image: nginx:alpine
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api
      - admin
    restart: unless-stopped
    networks:
      - festivals-network
    profiles:
      - proxy

  # ============================================================================
  # POSTGRESQL DATABASE
  # ============================================================================
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-festivals}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-password}
      POSTGRES_DB: ${POSTGRES_DB:-festivals}
      # Performance tuning for development
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=en_US.UTF-8"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./backend/scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-festivals} -d ${POSTGRES_DB:-festivals}"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
    networks:
      - festivals-network

  # ============================================================================
  # REDIS CACHE & QUEUE
  # ============================================================================
  redis:
    image: redis:7-alpine
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: >
      redis-server
      --appendonly yes
      --maxmemory ${REDIS_MAXMEMORY:-256mb}
      --maxmemory-policy allkeys-lru
      ${REDIS_PASSWORD:+--requirepass ${REDIS_PASSWORD}}
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    restart: unless-stopped
    networks:
      - festivals-network

  # ============================================================================
  # MINIO OBJECT STORAGE
  # ============================================================================
  # S3-compatible object storage for file uploads
  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio123}
      # Optional: Enable MinIO metrics
      MINIO_PROMETHEUS_AUTH_TYPE: public
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    volumes:
      - minio_data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    networks:
      - festivals-network

  # ============================================================================
  # ADMINER - DATABASE UI
  # ============================================================================
  # Web-based database management tool
  adminer:
    image: adminer:latest
    ports:
      - "${ADMINER_PORT:-8082}:8080"
    environment:
      ADMINER_DEFAULT_SERVER: postgres
    depends_on:
      - postgres
    restart: unless-stopped
    networks:
      - festivals-network
    profiles:
      - tools

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  festivals-network:
    driver: bridge
    name: festivals-network

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  postgres_data:
    name: festivals_postgres_data
  redis_data:
    name: festivals_redis_data
  minio_data:
    name: festivals_minio_data
  go_modules:
    name: festivals_go_modules
