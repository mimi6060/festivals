# Development Dockerfile with hot reload using Air
FROM golang:1.23-alpine

WORKDIR /app

# Install dependencies including air for hot reload
RUN apk add --no-cache git curl && \
    go install github.com/air-verse/air@v1.52.3

# Copy all source code
COPY . .

# Download dependencies
ENV GOTOOLCHAIN=auto
RUN go mod tidy && go mod download

# Create air config if not exists
RUN if [ ! -f .air.toml ]; then \
    echo 'root = "."' > .air.toml && \
    echo 'tmp_dir = "tmp"' >> .air.toml && \
    echo '' >> .air.toml && \
    echo '[build]' >> .air.toml && \
    echo 'cmd = "go build -o ./tmp/api ./cmd/api"' >> .air.toml && \
    echo 'bin = "./tmp/api"' >> .air.toml && \
    echo 'full_bin = "./tmp/api"' >> .air.toml && \
    echo 'include_ext = ["go", "tpl", "tmpl", "html"]' >> .air.toml && \
    echo 'exclude_dir = ["assets", "tmp", "vendor", "node_modules"]' >> .air.toml && \
    echo 'exclude_file = []' >> .air.toml && \
    echo 'delay = 1000' >> .air.toml && \
    echo 'stop_on_error = true' >> .air.toml && \
    echo 'log = "air.log"' >> .air.toml && \
    echo '' >> .air.toml && \
    echo '[log]' >> .air.toml && \
    echo 'time = false' >> .air.toml && \
    echo '' >> .air.toml && \
    echo '[color]' >> .air.toml && \
    echo 'main = "magenta"' >> .air.toml && \
    echo 'watcher = "cyan"' >> .air.toml && \
    echo 'build = "yellow"' >> .air.toml && \
    echo 'runner = "green"' >> .air.toml && \
    echo '' >> .air.toml && \
    echo '[misc]' >> .air.toml && \
    echo 'clean_on_exit = true' >> .air.toml; \
    fi

# Expose port
EXPOSE 8080

# Run with air for hot reload (generate go.sum first since volume mounts override it)
CMD ["sh", "-c", "go mod tidy && air -c .air.toml"]
