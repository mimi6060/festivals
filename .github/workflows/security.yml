name: Security

on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main
      - development
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  # ============================================
  # Go Security Scanning (gosec)
  # ============================================
  gosec:
    name: Go Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Run gosec
        uses: securego/gosec@master
        with:
          args: '-fmt sarif -out gosec-results.sarif -severity high,critical -exclude-dir=vendor ./backend/...'

      - name: Upload gosec SARIF report
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gosec-results.sarif
          category: gosec

      - name: Run gosec (text output for logs)
        uses: securego/gosec@master
        with:
          args: '-fmt text -severity high,critical -exclude-dir=vendor ./backend/...'

  # ============================================
  # Go Vulnerability Check (govulncheck)
  # ============================================
  govulncheck:
    name: Go Vulnerability Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

  # ============================================
  # NPM Audit (Admin)
  # ============================================
  npm-audit-admin:
    name: NPM Audit (Admin)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./admin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: '8'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: admin/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: Run npm audit (detailed)
        run: |
          npm audit --json > npm-audit-results.json || true

          # Parse and check for high/critical vulnerabilities
          HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
          CRITICAL_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)

          echo "High severity vulnerabilities: $HIGH_COUNT"
          echo "Critical severity vulnerabilities: $CRITICAL_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::Found $CRITICAL_COUNT critical vulnerabilities"
            exit 1
          fi

          if [ "$HIGH_COUNT" -gt 5 ]; then
            echo "::warning::Found $HIGH_COUNT high severity vulnerabilities"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-admin
          path: admin/npm-audit-results.json
          retention-days: 7

  # ============================================
  # NPM Audit (Mobile)
  # ============================================
  npm-audit-mobile:
    name: NPM Audit (Mobile)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./mobile

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: |
          npm audit --json > npm-audit-results.json || true

          # Parse and check for high/critical vulnerabilities
          HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' npm-audit-results.json)
          CRITICAL_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' npm-audit-results.json)

          echo "High severity vulnerabilities: $HIGH_COUNT"
          echo "Critical severity vulnerabilities: $CRITICAL_COUNT"

          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "::error::Found $CRITICAL_COUNT critical vulnerabilities"
            exit 1
          fi

          if [ "$HIGH_COUNT" -gt 5 ]; then
            echo "::warning::Found $HIGH_COUNT high severity vulnerabilities"
          fi

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: npm-audit-mobile
          path: mobile/npm-audit-results.json
          retention-days: 7

  # ============================================
  # Trivy Container Scanning
  # ============================================
  trivy-backend:
    name: Trivy Scan (Backend)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-backend-fs.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy FS SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-backend-fs.sarif
          category: trivy-backend-fs

      - name: Build Docker image for scanning
        run: |
          docker build -t festivals-api:scan -f backend/Dockerfile --target api backend/

      - name: Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'festivals-api:scan'
          format: 'sarif'
          output: 'trivy-backend-container.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy Container SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-backend-container.sarif
          category: trivy-backend-container

  trivy-admin:
    name: Trivy Scan (Admin)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './admin'
          format: 'sarif'
          output: 'trivy-admin-fs.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '0'

      - name: Upload Trivy FS SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-admin-fs.sarif
          category: trivy-admin-fs

      - name: Build Docker image for scanning
        run: |
          docker build -t festivals-admin:scan -f admin/Dockerfile admin/

      - name: Run Trivy container scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'festivals-admin:scan'
          format: 'sarif'
          output: 'trivy-admin-container.sarif'
          severity: 'HIGH,CRITICAL'
          exit-code: '1'
          ignore-unfixed: true

      - name: Upload Trivy Container SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: trivy-admin-container.sarif
          category: trivy-admin-container

  # ============================================
  # Gitleaks Secret Detection
  # ============================================
  gitleaks:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

      - name: Run Gitleaks (local fallback)
        if: failure()
        run: |
          # Install gitleaks
          wget -O gitleaks.tar.gz https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks.tar.gz
          chmod +x gitleaks

          # Run scan
          ./gitleaks detect --source . --verbose --report-format sarif --report-path gitleaks-results.sarif

          # Check exit code
          if [ $? -ne 0 ]; then
            echo "::error::Secrets detected in repository!"
            exit 1
          fi

      - name: Upload Gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: gitleaks-results.sarif
          category: gitleaks
        continue-on-error: true

  # ============================================
  # Dependency License Check
  # ============================================
  license-check:
    name: License Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Install go-licenses
        run: go install github.com/google/go-licenses@latest

      - name: Check Go licenses
        working-directory: ./backend
        run: |
          go-licenses report ./... > licenses.txt 2>&1 || true

          # Check for copyleft licenses
          if grep -iE "(GPL|AGPL|LGPL|MPL|CDDL)" licenses.txt; then
            echo "::warning::Copyleft licenses detected - review required"
          fi

          echo "License report generated"

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: backend/licenses.txt
          retention-days: 30

  # ============================================
  # CodeQL Analysis
  # ============================================
  codeql-go:
    name: CodeQL Analysis (Go)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: go
          queries: security-and-quality

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache-dependency-path: backend/go.sum

      - name: Build Go code
        working-directory: ./backend
        run: go build ./...

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: codeql-go

  codeql-javascript:
    name: CodeQL Analysis (JavaScript/TypeScript)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript
          queries: security-and-quality

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: codeql-javascript

  # ============================================
  # Security Summary
  # ============================================
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [gosec, govulncheck, npm-audit-admin, npm-audit-mobile, trivy-backend, trivy-admin, gitleaks]
    if: always()

    steps:
      - name: Check security scan results
        run: |
          echo "=== Security Scan Summary ==="
          echo "gosec: ${{ needs.gosec.result }}"
          echo "govulncheck: ${{ needs.govulncheck.result }}"
          echo "npm-audit-admin: ${{ needs.npm-audit-admin.result }}"
          echo "npm-audit-mobile: ${{ needs.npm-audit-mobile.result }}"
          echo "trivy-backend: ${{ needs.trivy-backend.result }}"
          echo "trivy-admin: ${{ needs.trivy-admin.result }}"
          echo "gitleaks: ${{ needs.gitleaks.result }}"

          # Fail if critical security scans failed
          if [[ "${{ needs.gitleaks.result }}" == "failure" ]]; then
            echo "::error::Secret detection found issues!"
            exit 1
          fi

          if [[ "${{ needs.gosec.result }}" == "failure" ]]; then
            echo "::error::Go security scan found high/critical issues!"
            exit 1
          fi

          if [[ "${{ needs.trivy-backend.result }}" == "failure" ]] || \
             [[ "${{ needs.trivy-admin.result }}" == "failure" ]]; then
            echo "::error::Container security scan found critical vulnerabilities!"
            exit 1
          fi

          echo "All critical security checks passed!"

      - name: Create security report
        if: github.event_name == 'schedule'
        run: |
          echo "# Daily Security Scan Report" > security-report.md
          echo "" >> security-report.md
          echo "**Date:** $(date -u +%Y-%m-%d)" >> security-report.md
          echo "" >> security-report.md
          echo "## Results" >> security-report.md
          echo "" >> security-report.md
          echo "| Scan | Result |" >> security-report.md
          echo "|------|--------|" >> security-report.md
          echo "| gosec | ${{ needs.gosec.result }} |" >> security-report.md
          echo "| govulncheck | ${{ needs.govulncheck.result }} |" >> security-report.md
          echo "| npm-audit-admin | ${{ needs.npm-audit-admin.result }} |" >> security-report.md
          echo "| npm-audit-mobile | ${{ needs.npm-audit-mobile.result }} |" >> security-report.md
          echo "| trivy-backend | ${{ needs.trivy-backend.result }} |" >> security-report.md
          echo "| trivy-admin | ${{ needs.trivy-admin.result }} |" >> security-report.md
          echo "| gitleaks | ${{ needs.gitleaks.result }} |" >> security-report.md

      - name: Upload security report
        if: github.event_name == 'schedule'
        uses: actions/upload-artifact@v4
        with:
          name: daily-security-report
          path: security-report.md
          retention-days: 90
